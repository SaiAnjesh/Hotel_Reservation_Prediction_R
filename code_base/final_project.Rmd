---
title: "Final Project"
author: "Sai Anjesh"
date: "2024-04-16"
output: html_notebook
---

# HOTEL RESERVATION CANCELLATION PREDCITION


```{r}
## Importing Necessary Libraries
##---------
FUNCTIONS_PATH = "D:/UIS/Studies/Semester4/CSC532/Assignments/ML_Final_Project/ml_final_project/code_base/custom_functions.R"
##---------
source(FUNCTIONS_PATH)
##---------
library(dplyr)
library(ROCR)
library(caret)
library(glmnet)
library(randomForest)
library(gbm)
library(keras)
library(tfruns)
library(abind)
library(mltools)
library(data.table)
##---------
```


```{r}
# I am creating this to save models
# Most of the models take time to run
# Can uuse these model objects later during the process

# CHAT_GPT Assistance: how to create folder if it does not exist in R?
# Specify the path to the folder you want to create
models_folder_path <- "D:/UIS/Studies/Semester4/CSC532/Assignments/ML_Final_Project/ml_final_project/ALL_MODELS"

# Check if the folder exists
if (!file.exists(models_folder_path)) {
  # If the folder does not exist, create it
  dir.create(models_folder_path)
  cat("Folder created successfully!\n")
} else {
  cat("Folder already exists!\n")
}
```


#### Let us import dataset

```{r}
## File Paths
input_folder_path = "D:/UIS/Studies/Semester4/CSC532/Assignments/ML_Final_Project/ml_final_project/input_datasets/"
input_file_name = "hotel_reservations_dataset/Hotel Reservations.csv"
hotel_reservation_data = paste(input_folder_path, input_file_name, sep = "")
```

```{r}
hotel_reservation_data <- read.csv(file = hotel_reservation_data, header = TRUE)
```

#### Let us check some basic information

```{r}
## Primitive Information
# Let us check the shape of the data
print(paste("Number of Records : ", dim(hotel_reservation_data)[1]))
print(paste("Number of Features : ", dim(hotel_reservation_data)[2]))

# Let us check the feature name snad the structure
str(hotel_reservation_data)

# Check the summary
summary(hotel_reservation_data)
```



##### Let us check the NA values

```{r}
# Let us check the NA cases
# Check if there are missing values
# And let us do a thorough check
sum(is.na(hotel_reservation_data))
colSums(is.na(hotel_reservation_data))

# Check 1
na_records <- hotel_reservation_data[!complete.cases(hotel_reservation_data), ]
```


Fortunately we don't have NA values, we shall continue to transform the structure.

#### Let us convert the struture of the dataframe
```{r}
# Check the str
str(hotel_reservation_data)

categorized_features <- categorize_features(hotel_reservation_data)
# Checking the column names
cat("Numeric columns: \n------\n", paste(categorized_features$numeric_cols, collapse = ", "), "\n")
cat("Factor columns: \n------\n", paste(categorized_features$factor_cols, collapse = ", "), "\n")
cat("Character columns: \n------\n", paste(categorized_features$character_cols, collapse = ", "),"\n")
```
```{r}
# # Let us check the character variables and understand the unique values
# for(col_val in categorized_features$character_cols) {
#   cat(paste("-----", col_val, "-----\n", sep = ""))
#   cat(paste(sort(unique(hotel_reservation_data[[col_val]]), decreasing = F), collapse = ", "), "\n")
# }

```


```{r}
# Removing the first Column 
# Jsut a unique identifier
hotel_reservation_data$Booking_ID <- NULL

# Final OutCome column - Modified
# I We are chaging hte outcome variable, for simplfied understanding of the model and data
hotel_reservation_data$booking_cancellation <- ifelse((hotel_reservation_data$booking_status == "Canceled"), "yes", "no")
hotel_reservation_data$booking_cancellation <- factor(hotel_reservation_data$booking_cancellation)
hotel_reservation_data$booking_status <- NULL

hotel_reservation_data$market_segment_type <- factor(hotel_reservation_data$market_segment_type)
hotel_reservation_data$type_of_meal_plan <- factor(hotel_reservation_data$type_of_meal_plan)
hotel_reservation_data$room_type_reserved <- factor(hotel_reservation_data$room_type_reserved)

# Since these are just variables
# We are going to give life to it by assigneing various room types
# CREDITS: https://hoteltechreport.com/news/room-type


# c("Room_Type 1", "Room_Type 2", "Room_Type 3", "Room_Type 4", "Room_Type 5", "Room_Type 6", "Room_Type 7")
# # c("standard_room", "deluxe_room", "joint_room", "connecting_room", "suite_room", "apartment_style_room", "accessible_room")


```



```{r}
# Check the str
str(hotel_reservation_data)

categorized_features <- categorize_features(hotel_reservation_data)
# Checking the column names
cat("Numeric columns: \n------\n", paste(categorized_features$numeric_cols, collapse = ", "), "\n")
cat("Factor columns: \n------\n", paste(categorized_features$factor_cols, collapse = ", "), "\n")
cat("Character columns: \n------\n", paste(categorized_features$character_cols, collapse = ", "),"\n")
```

## NOTE: WE HAVE SKIPPED THE EDA PART....WE WILL HAVE TO COMPLETE IT


#### Let us get started with the modeling

```{r}
# Let us check the class blance
prop.table(table(hotel_reservation_data$booking_cancellation))
```
From the above classes table we can surely say that the 

```{r}
# Let us bacup saiing a data
hotel_reservation_data_processed_bkup <- hotel_reservation_data
```


```{r}
# Let us split the data into train and test
# We are using 90% train and 10% test
# We have over 30K reords
train_index <- createDataPartition(y = hotel_reservation_data$booking_cancellation, p = 0.9, list = FALSE)
hotel_reservation_data_train <- hotel_reservation_data[train_index, ]
hotel_reservation_data_test <- hotel_reservation_data[-train_index, ]
```


```{r}
# Let us determiine the class weights
class_weights_values <- class_weight_determination_fn(output_var = hotel_reservation_data_train$booking_cancellation)
class_weights_vector <- ifelse(hotel_reservation_data_train$booking_cancellation == "yes", 
                               class_weights_values$weight_yes, class_weights_values$weight_no)

```



```{r}
MODEL_LIST <- list()
# Control Variables
MODEL_K_FOLDS <- 10
MODEL_CONTROL_METHOD <- "cv"
MODEL_TRAIN_METHOD <- "gbm"
MODEL_METRIC <- "ROC"
MODEL_TRAIN_DATA <- hotel_reservation_data_train
MODEL_TEST_DATA <- hotel_reservation_data_test
MODEL_DV_VAR <- "booking_cancellation"
##-------
ALPHA_VALUE = list(
  LASSO = 1,
  RIDGE = 0,
  ELASTIC = seq(0, 1, length = 10)
)
LAMBDA_GRID <- 10^seq(-3, 3, length = 100)
``` 




```{r}
# First model
set.seed(1)
control_values <- trainControl(method = MODEL_CONTROL_METHOD, 
                               number = MODEL_K_FOLDS, 
                               classProbs = TRUE, 
                               summaryFunction = twoClassSummary)

m_weighted_gbm <- train(booking_cancellation ~ ., 
                        data = MODEL_TRAIN_DATA, 
                        method = "gbm", 
                        weights = class_weights_vector,
                        # verbose = TRUE, 
                        verbose = FALSE, 
                        metric = MODEL_METRIC, 
                        trControl = control_values)
print(m_weighted_gbm)
# Savig the model objects for future use
MODEL_NAME <- "GRADIENT_BOOST" 
MODEL_LIST[["GRADIENT_BOOST"]] <- m_weighted_gbm
saveRDS(RANDOM_FOREST_MODEL, file = paste(models_folder_path,"/", "RANDOM_FOREST_MODEL.rds",sep = ""))
```


```{r}
set.seed(1)

LASSO_MODEL <- train(booking_cancellation ~.,
                     data = MODEL_TRAIN_DATA,
                     method = "glmnet",
                     metric = MODEL_METRIC,
                     trControl = control_values,
                     tuneGrid = expand.grid(alpha = ALPHA_VALUE$LASSO, lambda = LAMBDA_GRID),
                     verboseIter = TRUE,
                     verbose = TRUE)

print(LASSO_MODEL)
print(coef(LASSO_MODEL$finalModel, LASSO_MODEL$bestTune$lambda))

# Model Saving Process

saveRDS(RANDOM_FOREST_MODEL, file = paste(models_folder_path,"/", "RANDOM_FOREST_MODEL.rds",sep = ""))
```

```{r}


# gbm_predictions_prob = predict(m_weighted_gbm, MODEL_TEST_DATA, type="prob")
# gbm_predictions = prediction(predictions = gbm_predictions_prob$yes, MODEL_TEST_DATA$booking_cancellation)
# 
# performance(gbm_predictions, measure = "auc")@y.values
# 
# gbm_predicted_labels = predict(m_weighted_gbm, MODEL_TEST_DATA)
# confusionMatrix(gbm_predicted_labels, MODEL_TEST_DATA$booking_cancellation, positive="yes", mode="everything")
```


```{r}
# Models_List

```


```{r}
# Models Evaluation
for()
print(classification_evaluation_fn(model_selected_var = m_weighted_gbm, 
                                   test_data_selected = MODEL_TEST_DATA,
                                   focus_outcome = MODEL_DV_VAR))

```



```{r}

```

